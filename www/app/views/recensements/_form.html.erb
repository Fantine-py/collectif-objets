<div data-controller="recensement">
  <% if recensement.errors.any? %>
    <div class="fr-alert fr-alert--error fr-mb-6w">
      <p>
        Votre recensement n'a pas pu être enregistré :
        <ul>
          <% recensement.errors.attribute_names.each do |attribute| %>
            <li><%= recensement.errors.messages_for(attribute).first %></li>
          <% end %>
        </ul>
      </p>
    </div>
  <% end %>

  <div class="fr-grid-row">
    <div class="fr-col-md-6">
      <div class="co-objet-summary">
        <div class="co-objet-thumb">
          <% if recensement.objet.image_urls.any? %>
            <img src="<%= recensement.objet.image_urls[0] %>" alt="">
          <% else %>
            <%= image_tag "illustrations/photo-manquante.png" %>
          <% end %>
        </div>
        <div class="co-objet-desc">
          <div>
            <b><%= recensement.objet.nom_courant %></b><br />
            <%= recensement.objet.edifice_nom %> (<%= recensement.objet.commune.nom %>) <br />

            <span class="co-text--muted"><%= recensement.objet.ref_pop%></span>
          </div>
          <div>
            <%= link_to "← Revenir à la fiche objet", objet_path(recensement.objet) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h2 class="co-text--blue fr-mt-6w fr-mb-3w">Recensement</h2>

  <p class="co-text--muted fr-mb-6w">
    Tous les champs marqués d’un astérisque <span class="co-text--blue">*</span>
  sont obligatoires
  </p>

  <%= form_for(
    recensement,
    url: recensement.persisted? ? objet_recensement_path(recensement.objet, recensement) : objet_recensements_path(recensement.objet),
    builder: FormBuilderDsfr,
    html: { "data-recensement-target": "form" }
    ) do |f|
  %>
    <div class="fr-grid-row fr-mb-12w fr-grid-row--gutters">
      <div class="fr-col-md-6">
        <div class="fr-checkbox-group">
          <input
            type="checkbox"
            id="recensement[confirmation]"
            name="recensement[confirmation]"
            <%= "checked" if recensement.confirmation %>
            <%= "disabled" if recensement.persisted? %>
          >
          <label class="fr-label" for="recensement[confirmation]">
            Je confirme m'être déplacé voir l'objet pour ce recensement
          </label>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        L'intérêt de ce recensement est de constater l'état de l'objet à un instant. Il est donc nécessaire de vous déplacer pour faire vos observations. Vous ne pouvez pas vous baser sur des documents déjà établis auparavant.
      </div>
    </div>

    <div class="fr-grid-row fr-grid-row--gutters fr-my-12w" >
      <div class="fr-col-md-6">
        <div data-recensement-target="localisation">
          <%= render(
            "forms/collection_radio_buttons",
            f: f, legend: 'Où se trouve l’objet ? <span class="co-text--blue">*</span>',
            field_name: :localisation,
            options: localisation_options(recensement)
          ) %>
        </div>
        <div data-recensement-target="edificeNom">
          <% has_error = recensement.errors.attribute_names.include?(:edifice_nom) %>
          <div class="fr-input-group <%= "fr-input-group--error" if has_error %>">
            <%= f.label :edifice_nom,
              'Précisez le nom de l’édifice dans lequel se trouve l’objet <span class="co-text--blue">*</span>'.html_safe
            %>
            <%= f.text_field :edifice_nom, "aria-describedby": ("edifice-nom-desc-error" if has_error) %>
            <% if has_error %>
              <p id="edifice-nom-desc-error" class="fr-error-text">
                <%= recensement.errors.messages_for(:edifice_nom).first %>
              </p>
            <% end %>
          </div>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Si vous ne trouvez pas l'objet après avoir inspecté toutes les parties
          de l'édifice, il convient d’interroger certaines personnes : les
          habitués, un représentant de la paroisse ou le curé lui-même, la
          personne en charge des accès à l’édifice, etc.
        </p>
        <%= link_to "Voir la page 12 du guide", "https://fichiers.collectif-objets.beta.gouv.fr/Guidederecensement.pdf", target: "_blank", rel: "noopener" %>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w" data-recensement-target="recensable">
      <div class="fr-col-md-6">
        <div>
          <%= render(
            "forms/collection_radio_buttons",
            f: f, legend: 'L’objet peut-il être recensé ? <span class="co-text--blue">*</span>',
            field_name: :recensable, options: recensable_options
          ) %>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Les objets ne sont parfois physiquement pas recensables, par exemple si vous n’avez pas accès à l'édifice.
        </p>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w" data-recensement-target="etatSanitaireEdifice">
      <div class="fr-col-md-6">
        <div>
          <%= render(
            "forms/collection_radio_buttons",
            f: f, legend: 'Comment évaluez-vous l’état sanitaire de l’édifice à proximité de l’objet ? <span class="co-text--blue">*</span>',
            field_name: :etat_sanitaire_edifice, options: etat_sanitaire_options
          ) %>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
        À cette étape, il s’agit d’abord de regarder l'édifice dans son ensemble. Très
        souvent, les objets souffrent parce que le bâtiment qui les abrite est dans
        un état préoccupant. Ensuite, renseignez pour chaque objet votre
        impression sur l'état sanitaire de la partie de l’immeuble qui abrite l’objet,
        sur une échelle à 4 niveaux : bon, moyen, mauvais, péril.
        </p>
        <%= link_to "Voir la page 13 du guide", "https://fichiers.collectif-objets.beta.gouv.fr/Guidederecensement.pdf", target: "_blank", rel: "noopener" %>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w" data-recensement-target="etatSanitaire">
      <div class="fr-col-md-6">
        <div>
          <%= render(
            "forms/collection_radio_buttons",
            f: f, legend: 'Comment évaluez-vous l’état sanitaire de l’objet ? <span class="co-text--blue">*</span>',
            field_name: :etat_sanitaire, options: etat_sanitaire_options
          ) %>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Pour vous aider à estimer cet état sanitaire et la vitesse de dégradation,
          deux points sont à observer:
          <ul>
            <li>L'environnement immédiat de l'objet : remarquez-vous des
              déjections, des tas de poussières amoncelés au pied de l'objet, des
              éclats ou morceaux tombés</li>
            <li>L'objet lui-même : son intégrité est-elle bonne, la peinture qui le
                recouvre est-elle homogène, a-t-il l'air contaminé par un champignon,
                un ver, une mousse ?</li>
        </p>
        <%= link_to "Voir les points d'attention en fonction de la
nature des objets page 15 et 16 du guide", "https://fichiers.collectif-objets.beta.gouv.fr/Guidederecensement.pdf", target: "_blank", rel: "noopener" %>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w" data-recensement-target="securisation">
      <div class="fr-col-md-6">
        <div>
          <%= render(
            "forms/collection_radio_buttons",
            f: f, legend: 'L’objet est-il en sécurité ? <span class="co-text--blue">*</span>',
            field_name: :securisation, options: securisation_options
          ) %>
        </div>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Si l'objet est très lourd, accroché en hauteur, dans une niche
          inaccessible, vous pouvez cocher oui. On considère qu'il est sécurisé
          par sa nature ou son emplacement<br />
          Si l'objet se trouve dans une armoire, assurez-vous que la clef ne reste
          pas sur la serrure ou que le coffre soit déverrouillé. Si c'est le cas et que
          vous ne pouvez rien faire, cochez non, l'objet n'est pas sécurisé.
        </p>
        <%= link_to "Voir la page 18 du guide", "https://fichiers.collectif-objets.beta.gouv.fr/Guidederecensement.pdf", target: "_blank", rel: "noopener" %>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w">
      <div class="fr-col-md-6">
        <%= render "form_photos", f: %>
      </div>
      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Il ne s’agit pas ici de prises de vue artistiques. Ces photos doivent nous aider à mieux appréhender votre évaluation. <br />
          Les prises de vue contiennent idéalement :
          <ul>
            <li>Une vue de l’objet entier de face</li>
            <li>Une vue de l’objet entier de côté</li>
            <li>Une ou plusieurs photos de détails sur les points d’attention signalés dans ce questionnaire de l’objet</li>
          </ul>
          Vous pouvez glisser vos fichiers photos depuis votre ordinateur en dessous de ce texte dans l'emplacement "Drop files here".
        </p>
        <%= link_to "Voir la page 19 du guide", "https://fichiers.collectif-objets.beta.gouv.fr/Guidederecensement.pdf", target: "_blank", rel: "noopener" %>
      </div>
    </div>

    <div class="fr-grid-row fr-my-12w" data-recensement-target="notes">
      <div class="fr-col-md-6">
        <div class="fr-input-group">
          <%= f.label :notes, "Notes" %>
          <%= f.text_area :notes %>
        </div>
      </div>

      <div class="fr-col-md-6 co-text--muted co-form-explanations">
        <p>
          Vous pouvez ajouter ici vos remarques sur la localisation, l'état sanitaire, la sécurisation, les dégradations…
        </p>
      </div>
    </div>

    <%= f.submit "Enregistrer ce recensement" %>
    <span>Vous pourrez toujours le modifier avant la validation</span>
  <% end %>
</main>
