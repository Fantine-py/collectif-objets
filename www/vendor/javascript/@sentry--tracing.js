import{__assign as t,__extends as e,__values as n,__spread as a,__read as r,__rest as i}from"tslib";import{getCurrentHub as s,Hub as o,getMainCarrier as c}from"@sentry/hub";import{addInstrumentationHandler as d,logger as u,uuid4 as p,timestampWithMs as l,dropUndefinedKeys as m,isInstanceOf as f,isNaN as h,dynamicRequire as v,loadModule as g,isNodeEnv as _,fill as T,isThenable as y,getGlobalObject as S,browserPerformanceTimeOrigin as b,htmlTreeAsString as I,isMatchingPattern as x,extractTraceparentData as C}from"@sentry/utils";export{TRACEPARENT_REGEXP,extractTraceparentData,stripUrlQueryAndFragment}from"@sentry/utils";var E="undefined"===typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__;function hasTracingEnabled(t){var e=s().getClient();var n=t||e&&e.getOptions();return!!n&&("tracesSampleRate"in n||"tracesSampler"in n)}function getActiveTransaction(t){var e=t||s();var n=e.getScope();return n&&n.getTransaction()}
/**
 * Converts from milliseconds to seconds
 * @param time time in ms
 */function msToSec(t){return t/1e3}
/**
 * Converts from seconds to milliseconds
 * @param time time in seconds
 */function secToMs(t){return 1e3*t}function registerErrorInstrumentation(){d("error",errorCallback);d("unhandledrejection",errorCallback)}function errorCallback(){var t=getActiveTransaction();if(t){var e="internal_error";E&&u.log("[Tracing] Transaction: "+e+" -> Global error occured");t.setStatus(e)}}var M="finishReason";var O=["heartbeatFailed","idleTimeout","documentHidden"];var R=function(){function SpanRecorder(t){void 0===t&&(t=1e3);this.spans=[];this._maxlen=t}SpanRecorder.prototype.add=function(t){this.spans.length>this._maxlen?t.spanRecorder=void 0:this.spans.push(t)};return SpanRecorder}();var k=function(){function Span(t){this.traceId=p();this.spanId=p().substring(16);this.startTimestamp=l();this.tags={};this.data={};if(!t)return this;t.traceId&&(this.traceId=t.traceId);t.spanId&&(this.spanId=t.spanId);t.parentSpanId&&(this.parentSpanId=t.parentSpanId);"sampled"in t&&(this.sampled=t.sampled);t.op&&(this.op=t.op);t.description&&(this.description=t.description);t.data&&(this.data=t.data);t.tags&&(this.tags=t.tags);t.status&&(this.status=t.status);t.startTimestamp&&(this.startTimestamp=t.startTimestamp);t.endTimestamp&&(this.endTimestamp=t.endTimestamp)}
/**
     * @inheritDoc
     * @deprecated
     */Span.prototype.child=function(t){return this.startChild(t)};Span.prototype.startChild=function(e){var n=new Span(t(t({},e),{parentSpanId:this.spanId,sampled:this.sampled,traceId:this.traceId}));n.spanRecorder=this.spanRecorder;n.spanRecorder&&n.spanRecorder.add(n);n.transaction=this.transaction;return n};Span.prototype.setTag=function(e,n){var a;this.tags=t(t({},this.tags),(a={},a[e]=n,a));return this};Span.prototype.setData=function(e,n){var a;this.data=t(t({},this.data),(a={},a[e]=n,a));return this};Span.prototype.setStatus=function(t){this.status=t;return this};Span.prototype.setHttpStatus=function(t){this.setTag("http.status_code",String(t));var e=spanStatusfromHttpCode(t);"unknown_error"!==e&&this.setStatus(e);return this};Span.prototype.isSuccess=function(){return"ok"===this.status};Span.prototype.finish=function(t){this.endTimestamp="number"===typeof t?t:l()};Span.prototype.toTraceparent=function(){var t="";void 0!==this.sampled&&(t=this.sampled?"-1":"-0");return this.traceId+"-"+this.spanId+t};Span.prototype.toContext=function(){return m({data:this.data,description:this.description,endTimestamp:this.endTimestamp,op:this.op,parentSpanId:this.parentSpanId,sampled:this.sampled,spanId:this.spanId,startTimestamp:this.startTimestamp,status:this.status,tags:this.tags,traceId:this.traceId})};Span.prototype.updateWithContext=function(t){var e,n,a,r,i;this.data=(e=t.data,null!==e&&void 0!==e?e:{});this.description=t.description;this.endTimestamp=t.endTimestamp;this.op=t.op;this.parentSpanId=t.parentSpanId;this.sampled=t.sampled;this.spanId=(n=t.spanId,null!==n&&void 0!==n?n:this.spanId);this.startTimestamp=(a=t.startTimestamp,null!==a&&void 0!==a?a:this.startTimestamp);this.status=t.status;this.tags=(r=t.tags,null!==r&&void 0!==r?r:{});this.traceId=(i=t.traceId,null!==i&&void 0!==i?i:this.traceId);return this};Span.prototype.getTraceContext=function(){return m({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,trace_id:this.traceId})};Span.prototype.toJSON=function(){return m({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,start_timestamp:this.startTimestamp,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,timestamp:this.endTimestamp,trace_id:this.traceId})};return Span}();
/**
 * Converts a HTTP status code into a {@link SpanStatusType}.
 *
 * @param httpStatus The HTTP response status code.
 * @returns The span status or unknown_error.
 */function spanStatusfromHttpCode(t){if(t<400&&t>=100)return"ok";if(t>=400&&t<500)switch(t){case 401:return"unauthenticated";case 403:return"permission_denied";case 404:return"not_found";case 409:return"already_exists";case 413:return"failed_precondition";case 429:return"resource_exhausted";default:return"invalid_argument"}if(t>=500&&t<600)switch(t){case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline_exceeded";default:return"internal_error"}return"unknown_error"}var w=function(n){e(Transaction,n);function Transaction(t,e){var a=n.call(this,t)||this;a._measurements={};a._hub=s();f(e,o)&&(a._hub=e);a.name=t.name||"";a.metadata=t.metadata||{};a._trimEnd=t.trimEnd;a.transaction=a;return a}Transaction.prototype.setName=function(t){this.name=t};
/**
     * Attaches SpanRecorder to the span itself
     * @param maxlen maximum number of spans that can be recorded
     */Transaction.prototype.initSpanRecorder=function(t){void 0===t&&(t=1e3);this.spanRecorder||(this.spanRecorder=new R(t));this.spanRecorder.add(this)};Transaction.prototype.setMeasurements=function(e){this._measurements=t({},e)};Transaction.prototype.setMetadata=function(e){this.metadata=t(t({},this.metadata),e)};Transaction.prototype.finish=function(t){var e=this;if(void 0===this.endTimestamp){if(!this.name){E&&u.warn("Transaction has no name, falling back to `<unlabeled transaction>`.");this.name="<unlabeled transaction>"}n.prototype.finish.call(this,t);if(true===this.sampled){var a=this.spanRecorder?this.spanRecorder.spans.filter((function(t){return t!==e&&t.endTimestamp})):[];this._trimEnd&&a.length>0&&(this.endTimestamp=a.reduce((function(t,e){return t.endTimestamp&&e.endTimestamp?t.endTimestamp>e.endTimestamp?t:e:t})).endTimestamp);var r={contexts:{trace:this.getTraceContext()},spans:a,start_timestamp:this.startTimestamp,tags:this.tags,timestamp:this.endTimestamp,transaction:this.name,type:"transaction",sdkProcessingMetadata:this.metadata};var i=Object.keys(this._measurements).length>0;if(i){E&&u.log("[Measurements] Adding measurements to transaction",JSON.stringify(this._measurements,void 0,2));r.measurements=this._measurements}E&&u.log("[Tracing] Finishing "+this.op+" transaction: "+this.name+".");return this._hub.captureEvent(r)}E&&u.log("[Tracing] Discarding transaction because its trace was not chosen to be sampled.");var s=this._hub.getClient();var o=s&&s.getTransport&&s.getTransport();o&&o.recordLostEvent&&o.recordLostEvent("sample_rate","transaction")}};Transaction.prototype.toContext=function(){var e=n.prototype.toContext.call(this);return m(t(t({},e),{name:this.name,trimEnd:this._trimEnd}))};Transaction.prototype.updateWithContext=function(t){var e;n.prototype.updateWithContext.call(this,t);this.name=(e=t.name,null!==e&&void 0!==e?e:"");this._trimEnd=t.trimEnd;return this};return Transaction}(k);var A=1e3;var N=5e3;var D=function(t){e(IdleTransactionSpanRecorder,t);function IdleTransactionSpanRecorder(e,n,a,r){void 0===a&&(a="");var i=t.call(this,r)||this;i._pushActivity=e;i._popActivity=n;i.transactionSpanId=a;return i}IdleTransactionSpanRecorder.prototype.add=function(e){var n=this;if(e.spanId!==this.transactionSpanId){e.finish=function(t){e.endTimestamp="number"===typeof t?t:l();n._popActivity(e.spanId)};void 0===e.endTimestamp&&this._pushActivity(e.spanId)}t.prototype.add.call(this,e)};return IdleTransactionSpanRecorder}(R);var q=function(t){e(IdleTransaction,t);function IdleTransaction(e,n,a,r){void 0===a&&(a=A);void 0===r&&(r=false);var i=t.call(this,e,n)||this;i._idleHub=n;i._idleTimeout=a;i._onScope=r;i.activities={};i._heartbeatCounter=0;i._finished=false;i._beforeFinishCallbacks=[];if(n&&r){clearActiveTransaction(n);E&&u.log("Setting idle transaction on scope. Span ID: "+i.spanId);n.configureScope((function(t){return t.setSpan(i)}))}i._initTimeout=setTimeout((function(){i._finished||i.finish()}),i._idleTimeout);return i}IdleTransaction.prototype.finish=function(e){var a,r;var i=this;void 0===e&&(e=l());this._finished=true;this.activities={};if(this.spanRecorder){E&&u.log("[Tracing] finishing IdleTransaction",new Date(1e3*e).toISOString(),this.op);try{for(var s=n(this._beforeFinishCallbacks),o=s.next();!o.done;o=s.next()){var c=o.value;c(this,e)}}catch(t){a={error:t}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(a)throw a.error}}this.spanRecorder.spans=this.spanRecorder.spans.filter((function(t){if(t.spanId===i.spanId)return true;if(!t.endTimestamp){t.endTimestamp=e;t.setStatus("cancelled");E&&u.log("[Tracing] cancelling span since transaction ended early",JSON.stringify(t,void 0,2))}var n=t.startTimestamp<e;n||E&&u.log("[Tracing] discarding Span since it happened after Transaction was finished",JSON.stringify(t,void 0,2));return n}));E&&u.log("[Tracing] flushing IdleTransaction")}else E&&u.log("[Tracing] No active IdleTransaction");this._onScope&&clearActiveTransaction(this._idleHub);return t.prototype.finish.call(this,e)};IdleTransaction.prototype.registerBeforeFinishCallback=function(t){this._beforeFinishCallbacks.push(t)};IdleTransaction.prototype.initSpanRecorder=function(t){var e=this;if(!this.spanRecorder){var pushActivity=function(t){e._finished||e._pushActivity(t)};var popActivity=function(t){e._finished||e._popActivity(t)};this.spanRecorder=new D(pushActivity,popActivity,this.spanId,t);E&&u.log("Starting heartbeat");this._pingHeartbeat()}this.spanRecorder.add(this)};
/**
     * Start tracking a specific activity.
     * @param spanId The span id that represents the activity
     */IdleTransaction.prototype._pushActivity=function(t){if(this._initTimeout){clearTimeout(this._initTimeout);this._initTimeout=void 0}E&&u.log("[Tracing] pushActivity: "+t);this.activities[t]=true;E&&u.log("[Tracing] new activities count",Object.keys(this.activities).length)};
/**
     * Remove an activity from usage
     * @param spanId The span id that represents the activity
     */IdleTransaction.prototype._popActivity=function(t){var e=this;if(this.activities[t]){E&&u.log("[Tracing] popActivity "+t);delete this.activities[t];E&&u.log("[Tracing] new activities count",Object.keys(this.activities).length)}if(0===Object.keys(this.activities).length){var n=this._idleTimeout;var a=l()+n/1e3;setTimeout((function(){if(!e._finished){e.setTag(M,O[1]);e.finish(a)}}),n)}};IdleTransaction.prototype._beat=function(){if(!this._finished){var t=Object.keys(this.activities).join("");t===this._prevHeartbeatString?this._heartbeatCounter+=1:this._heartbeatCounter=1;this._prevHeartbeatString=t;if(this._heartbeatCounter>=3){E&&u.log("[Tracing] Transaction finished because of no change for 3 heart beats");this.setStatus("deadline_exceeded");this.setTag(M,O[0]);this.finish()}else this._pingHeartbeat()}};IdleTransaction.prototype._pingHeartbeat=function(){var t=this;E&&u.log("pinging Heartbeat -> current counter: "+this._heartbeatCounter);setTimeout((function(){t._beat()}),N)};return IdleTransaction}(w);function clearActiveTransaction(t){if(t){var e=t.getScope();if(e){var n=e.getTransaction();n&&e.setSpan(void 0)}}}function traceHeaders(){var t=this.getScope();if(t){var e=t.getSpan();if(e)return{"sentry-trace":e.toTraceparent()}}return{}}
/**
 * Makes a sampling decision for the given transaction and stores it on the transaction.
 *
 * Called every time a transaction is created. Only transactions which emerge with a `sampled` value of `true` will be
 * sent to Sentry.
 *
 * @param transaction: The transaction needing a sampling decision
 * @param options: The current client's options, so we can access `tracesSampleRate` and/or `tracesSampler`
 * @param samplingContext: Default and user-provided data which may be used to help make the decision
 *
 * @returns The given transaction with its `sampled` value set
 */function sample(t,e,n){if(!hasTracingEnabled(e)){t.sampled=false;return t}if(void 0!==t.sampled){t.setMetadata({transactionSampling:{method:"explicitly_set"}});return t}var a;if("function"===typeof e.tracesSampler){a=e.tracesSampler(n);t.setMetadata({transactionSampling:{method:"client_sampler",rate:Number(a)}})}else if(void 0!==n.parentSampled){a=n.parentSampled;t.setMetadata({transactionSampling:{method:"inheritance"}})}else{a=e.tracesSampleRate;t.setMetadata({transactionSampling:{method:"client_rate",rate:Number(a)}})}if(!isValidSampleRate(a)){E&&u.warn("[Tracing] Discarding transaction because of invalid sample rate.");t.sampled=false;return t}if(!a){E&&u.log("[Tracing] Discarding transaction because "+("function"===typeof e.tracesSampler?"tracesSampler returned 0 or false":"a negative sampling decision was inherited or tracesSampleRate is set to 0"));t.sampled=false;return t}t.sampled=Math.random()<a;if(!t.sampled){E&&u.log("[Tracing] Discarding transaction because it's not included in the random sample (sampling rate = "+Number(a)+")");return t}E&&u.log("[Tracing] starting "+t.op+" transaction - "+t.name);return t}function isValidSampleRate(t){if(h(t)||!("number"===typeof t||"boolean"===typeof t)){E&&u.warn("[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got "+JSON.stringify(t)+" of type "+JSON.stringify(typeof t)+".");return false}if(t<0||t>1){E&&u.warn("[Tracing] Given sample rate is invalid. Sample rate must be between 0 and 1. Got "+t+".");return false}return true}
/**
 * Creates a new transaction and adds a sampling decision if it doesn't yet have one.
 *
 * The Hub.startTransaction method delegates to this method to do its work, passing the Hub instance in as `this`, as if
 * it had been called on the hub directly. Exists as a separate function so that it can be injected into the class as an
 * "extension method."
 *
 * @param this: The Hub starting the transaction
 * @param transactionContext: Data used to configure the transaction
 * @param CustomSamplingContext: Optional data to be provided to the `tracesSampler` function (if any)
 *
 * @returns The new transaction
 *
 * @see {@link Hub.startTransaction}
 */function _startTransaction(e,n){var a=this.getClient();var r=a&&a.getOptions()||{};var i=new w(e,this);i=sample(i,r,t({parentSampled:e.parentSampled,transactionContext:e},n));i.sampled&&i.initSpanRecorder(r._experiments&&r._experiments.maxSpans);return i}function startIdleTransaction(e,n,a,r,i){var s=e.getClient();var o=s&&s.getOptions()||{};var c=new q(n,e,a,r);c=sample(c,o,t({parentSampled:n.parentSampled,transactionContext:n},i));c.sampled&&c.initSpanRecorder(o._experiments&&o._experiments.maxSpans);return c}function _addTracingExtensions(){var t=c();if(t.__SENTRY__){t.__SENTRY__.extensions=t.__SENTRY__.extensions||{};t.__SENTRY__.extensions.startTransaction||(t.__SENTRY__.extensions.startTransaction=_startTransaction);t.__SENTRY__.extensions.traceHeaders||(t.__SENTRY__.extensions.traceHeaders=traceHeaders)}}function _autoloadDatabaseIntegrations(){var t=c();if(t.__SENTRY__){var e={mongodb:function(){var t=v(module,"./integrations/node/mongo");return new t.Mongo},mongoose:function(){var t=v(module,"./integrations/node/mongo");return new t.Mongo({mongoose:true})},mysql:function(){var t=v(module,"./integrations/node/mysql");return new t.Mysql},pg:function(){var t=v(module,"./integrations/node/postgres");return new t.Postgres}};var n=Object.keys(e).filter((function(t){return!!g(t)})).map((function(t){try{return e[t]()}catch(t){return}})).filter((function(t){return t}));n.length>0&&(t.__SENTRY__.integrations=a(t.__SENTRY__.integrations||[],n))}}function addExtensionMethods(){_addTracingExtensions();_()&&_autoloadDatabaseIntegrations();registerErrorInstrumentation()}var P=function(){function Express(t){void 0===t&&(t={});this.name=Express.id;this._router=t.router||t.app;this._methods=(Array.isArray(t.methods)?t.methods:[]).concat("use")}Express.prototype.setupOnce=function(){this._router?instrumentMiddlewares(this._router,this._methods):E&&u.error("ExpressIntegration is missing an Express instance")};Express.id="Express";return Express}();function wrap(t,e){var n=t.length;switch(n){case 2:return function(n,a){var r=a.__sentry_transaction;if(r){var i=r.startChild({description:t.name,op:"express.middleware."+e});a.once("finish",(function(){i.finish()}))}return t.call(this,n,a)};case 3:return function(n,r,i){var s;var o=r.__sentry_transaction;var c=null===(s=o)||void 0===s?void 0:s.startChild({description:t.name,op:"express.middleware."+e});t.call(this,n,r,(function(){var t=[];for(var e=0;e<arguments.length;e++)t[e]=arguments[e];var n;null===(n=c)||void 0===n?void 0:n.finish();i.call.apply(i,a([this],t))}))};case 4:return function(n,r,i,s){var o;var c=i.__sentry_transaction;var d=null===(o=c)||void 0===o?void 0:o.startChild({description:t.name,op:"express.middleware."+e});t.call(this,n,r,i,(function(){var t=[];for(var e=0;e<arguments.length;e++)t[e]=arguments[e];var n;null===(n=d)||void 0===n?void 0:n.finish();s.call.apply(s,a([this],t))}))};default:throw new Error("Express middleware takes 2-4 arguments. Got: "+n)}}function wrapMiddlewareArgs(t,e){return t.map((function(t){return"function"===typeof t?wrap(t,e):Array.isArray(t)?t.map((function(t){return"function"===typeof t?wrap(t,e):t})):t}))}function patchMiddleware(t,e){var n=t[e];t[e]=function(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];return n.call.apply(n,a([this],wrapMiddlewareArgs(t,e)))};return t}function instrumentMiddlewares(t,e){void 0===e&&(e=[]);e.forEach((function(e){return patchMiddleware(t,e)}))}var H=function(){function Postgres(t){void 0===t&&(t={});this.name=Postgres.id;this._usePgNative=!!t.usePgNative}Postgres.prototype.setupOnce=function(t,e){var n;var a=g("pg");if(a)if(!this._usePgNative||(null===(n=a.native)||void 0===n?void 0:n.Client)){var r=(this._usePgNative?a.native:a).Client;T(r.prototype,"query",(function(t){return function(n,a,r){var i,s,o;var c=e().getScope();var d=null===(i=c)||void 0===i?void 0:i.getSpan();var u=null===(s=d)||void 0===s?void 0:s.startChild({description:"string"===typeof n?n:n.text,op:"db"});if("function"===typeof r)return t.call(this,n,a,(function(t,e){var n;null===(n=u)||void 0===n?void 0:n.finish();r(t,e)}));if("function"===typeof a)return t.call(this,n,(function(t,e){var n;null===(n=u)||void 0===n?void 0:n.finish();a(t,e)}));var p="undefined"!==typeof a?t.call(this,n,a):t.call(this,n);if(y(p))return p.then((function(t){var e;null===(e=u)||void 0===e?void 0:e.finish();return t}));null===(o=u)||void 0===o?void 0:o.finish();return p}}))}else E&&u.error("Postgres Integration was unable to access 'pg-native' bindings.");else E&&u.error("Postgres Integration was unable to require `pg` package.")};Postgres.id="Postgres";return Postgres}();var F=function(){function Mysql(){this.name=Mysql.id}Mysql.prototype.setupOnce=function(t,e){var n=g("mysql/lib/Connection.js");n?T(n,"createQuery",(function(t){return function(n,a,r){var i,s;var o=e().getScope();var c=null===(i=o)||void 0===i?void 0:i.getSpan();var d=null===(s=c)||void 0===s?void 0:s.startChild({description:"string"===typeof n?n:n.sql,op:"db"});return"function"===typeof r?t.call(this,n,a,(function(t,e,n){var a;null===(a=d)||void 0===a?void 0:a.finish();r(t,e,n)})):"function"===typeof a?t.call(this,n,(function(t,e,n){var r;null===(r=d)||void 0===r?void 0:r.finish();a(t,e,n)})):t.call(this,n,a,r)}})):E&&u.error("Mysql Integration was unable to require `mysql` package.")};Mysql.id="Mysql";return Mysql}();var L=["aggregate","bulkWrite","countDocuments","createIndex","createIndexes","deleteMany","deleteOne","distinct","drop","dropIndex","dropIndexes","estimatedDocumentCount","find","findOne","findOneAndDelete","findOneAndReplace","findOneAndUpdate","indexes","indexExists","indexInformation","initializeOrderedBulkOp","insertMany","insertOne","isCapped","mapReduce","options","parallelCollectionScan","rename","replaceOne","stats","updateMany","updateOne"];var B={bulkWrite:["operations"],countDocuments:["query"],createIndex:["fieldOrSpec"],createIndexes:["indexSpecs"],deleteMany:["filter"],deleteOne:["filter"],distinct:["key","query"],dropIndex:["indexName"],find:["query"],findOne:["query"],findOneAndDelete:["filter"],findOneAndReplace:["filter","replacement"],findOneAndUpdate:["filter","update"],indexExists:["indexes"],insertMany:["docs"],insertOne:["doc"],mapReduce:["map","reduce"],rename:["newName"],replaceOne:["filter","doc"],updateMany:["filter","update"],updateOne:["filter","update"]};var j=function(){function Mongo(t){void 0===t&&(t={});this.name=Mongo.id;this._operations=Array.isArray(t.operations)?t.operations:L;this._describeOperations=!("describeOperations"in t)||t.describeOperations;this._useMongoose=!!t.useMongoose}Mongo.prototype.setupOnce=function(t,e){var n=this._useMongoose?"mongoose":"mongodb";var a=g(n);a?this._instrumentOperations(a.Collection,this._operations,e):E&&u.error("Mongo Integration was unable to require `"+n+"` package.")};Mongo.prototype._instrumentOperations=function(t,e,n){var a=this;e.forEach((function(e){return a._patchOperation(t,e,n)}))};Mongo.prototype._patchOperation=function(t,e,n){if(e in t.prototype){var r=this._getSpanContextFromOperationArguments.bind(this);T(t.prototype,e,(function(t){return function(){var i=[];for(var s=0;s<arguments.length;s++)i[s]=arguments[s];var o,c,d,u;var p=i[i.length-1];var l=n().getScope();var m=null===(o=l)||void 0===o?void 0:o.getSpan();if("function"!==typeof p||"mapReduce"===e&&2===i.length){var f=null===(c=m)||void 0===c?void 0:c.startChild(r(this,e,i));var h=t.call.apply(t,a([this],i));if(y(h))return h.then((function(t){var e;null===(e=f)||void 0===e?void 0:e.finish();return t}));null===(d=f)||void 0===d?void 0:d.finish();return h}var v=null===(u=m)||void 0===u?void 0:u.startChild(r(this,e,i.slice(0,-1)));return t.call.apply(t,a([this],i.slice(0,-1),[function(t,e){var n;null===(n=v)||void 0===n?void 0:n.finish();p(t,e)}]))}}))}};Mongo.prototype._getSpanContextFromOperationArguments=function(t,e,n){var a={collectionName:t.collectionName,dbName:t.dbName,namespace:t.namespace};var i={op:"db",description:e,data:a};var s=B[e];var o=Array.isArray(this._describeOperations)?this._describeOperations.includes(e):this._describeOperations;if(!s||!o)return i;try{if("mapReduce"===e){var c=r(n,2),d=c[0],u=c[1];a[s[0]]="string"===typeof d?d:d.name||"<anonymous>";a[s[1]]="string"===typeof u?u:u.name||"<anonymous>"}else for(var p=0;p<s.length;p++)a[s[p]]=JSON.stringify(n[p])}catch(t){}return i};Mongo.id="Mongo";return Mongo}();var z=S();function registerBackgroundTabDetection(){z&&z.document?z.document.addEventListener("visibilitychange",(function(){var t=getActiveTransaction();if(z.document.hidden&&t){var e="cancelled";E&&u.log("[Tracing] Transaction: "+e+" -> since tab moved to the background, op: "+t.op);t.status||t.setStatus(e);t.setTag("visibilitychange","document.hidden");t.setTag(M,O[2]);t.finish()}})):E&&u.warn("[Tracing] Could not set up background tab detection due to lack of global document")}var bindReporter=function(t,e,n){var a;return function(r){if(e.value>=0&&(r||n)){e.delta=e.value-(a||0);if(e.delta||void 0===a){a=e.value;t(e)}}}};var generateUniqueID=function(){return"v2-"+Date.now()+"-"+(Math.floor(8999999999999*Math.random())+1e12)};var initMetric=function(t,e){return{name:t,value:null!==e&&void 0!==e?e:-1,delta:0,entries:[],id:generateUniqueID()}};var observe=function(t,e){try{if(PerformanceObserver.supportedEntryTypes.includes(t)){if("first-input"===t&&!("PerformanceEventTiming"in self))return;var n=new PerformanceObserver((function(t){return t.getEntries().map(e)}));n.observe({type:t,buffered:true});return n}}catch(t){}};var onHidden=function(t,e){var onHiddenOrPageHide=function(n){if("pagehide"===n.type||"hidden"===S().document.visibilityState){t(n);if(e){removeEventListener("visibilitychange",onHiddenOrPageHide,true);removeEventListener("pagehide",onHiddenOrPageHide,true)}}};addEventListener("visibilitychange",onHiddenOrPageHide,true);addEventListener("pagehide",onHiddenOrPageHide,true)};var getCLS=function(t,e){var n=initMetric("CLS",0);var a;var r=0;var i=[];var entryHandler=function(t){if(t&&!t.hadRecentInput){var e=i[0];var s=i[i.length-1];if(r&&0!==i.length&&t.startTime-s.startTime<1e3&&t.startTime-e.startTime<5e3){r+=t.value;i.push(t)}else{r=t.value;i=[t]}if(r>n.value){n.value=r;n.entries=i;a&&a()}}};var s=observe("layout-shift",entryHandler);if(s){a=bindReporter(t,n,e);onHidden((function(){s.takeRecords().map(entryHandler);a(true)}))}};var Y=-1;var initHiddenTime=function(){return"hidden"===S().document.visibilityState?0:Infinity};var trackChanges=function(){onHidden((function(t){var e=t.timeStamp;Y=e}),true)};var getVisibilityWatcher=function(){if(Y<0){Y=initHiddenTime();trackChanges()}return{get firstHiddenTime(){return Y}}};var getFID=function(t,e){var n=getVisibilityWatcher();var a=initMetric("FID");var r;var entryHandler=function(t){if(r&&t.startTime<n.firstHiddenTime){a.value=t.processingStart-t.startTime;a.entries.push(t);r(true)}};var i=observe("first-input",entryHandler);if(i){r=bindReporter(t,a,e);onHidden((function(){i.takeRecords().map(entryHandler);i.disconnect()}),true)}};var W={};var getLCP=function(t,e){var n=getVisibilityWatcher();var a=initMetric("LCP");var r;var entryHandler=function(t){var e=t.startTime;if(e<n.firstHiddenTime){a.value=e;a.entries.push(t)}r&&r()};var i=observe("largest-contentful-paint",entryHandler);if(i){r=bindReporter(t,a,e);var stopListening_1=function(){if(!W[a.id]){i.takeRecords().map(entryHandler);i.disconnect();W[a.id]=true;r(true)}};["keydown","click"].forEach((function(t){addEventListener(t,stopListening_1,{once:true,capture:true})}));onHidden(stopListening_1,true)}};var G=S();var U=function(){function MetricsInstrumentation(t){void 0===t&&(t=false);this._reportAllChanges=t;this._measurements={};this._performanceCursor=0;if(!_()&&G&&G.performance&&G.document){G.performance.mark&&G.performance.mark("sentry-tracing-init");this._trackCLS();this._trackLCP();this._trackFID()}}MetricsInstrumentation.prototype.addPerformanceEntries=function(t){var e=this;if(G&&G.performance&&G.performance.getEntries&&b){E&&u.log("[Tracing] Adding & adjusting spans using Performance API");var n=msToSec(b);var a;var r;G.performance.getEntries().slice(this._performanceCursor).forEach((function(i){var s=msToSec(i.startTime);var o=msToSec(i.duration);if(!("navigation"===t.op&&n+s<t.startTimestamp))switch(i.entryType){case"navigation":addNavigationSpans(t,i,n);a=n+msToSec(i.responseStart);r=n+msToSec(i.requestStart);break;case"mark":case"paint":case"measure":var c=addMeasureSpans(t,i,s,o,n);var d=getVisibilityWatcher();var p=i.startTime<d.firstHiddenTime;if("first-paint"===i.name&&p){E&&u.log("[Measurements] Adding FP");e._measurements.fp={value:i.startTime};e._measurements["mark.fp"]={value:c}}if("first-contentful-paint"===i.name&&p){E&&u.log("[Measurements] Adding FCP");e._measurements.fcp={value:i.startTime};e._measurements["mark.fcp"]={value:c}}break;case"resource":var l=i.name.replace(G.location.origin,"");addResourceSpans(t,i,l,s,o,n);break;default:}}));this._performanceCursor=Math.max(performance.getEntries().length-1,0);this._trackNavigator(t);if("pageload"===t.op){var i=msToSec(b);if("number"===typeof a){E&&u.log("[Measurements] Adding TTFB");this._measurements.ttfb={value:1e3*(a-t.startTimestamp)};"number"===typeof r&&r<=a&&(this._measurements["ttfb.requestTime"]={value:1e3*(a-r)})}["fcp","fp","lcp"].forEach((function(n){if(e._measurements[n]&&!(i>=t.startTimestamp)){var a=e._measurements[n].value;var r=i+msToSec(a);var s=Math.abs(1e3*(r-t.startTimestamp));var o=s-a;E&&u.log("[Measurements] Normalized "+n+" from "+a+" to "+s+" ("+o+")");e._measurements[n].value=s}}));this._measurements["mark.fid"]&&this._measurements.fid&&_startChild(t,{description:"first input delay",endTimestamp:this._measurements["mark.fid"].value+msToSec(this._measurements.fid.value),op:"web.vitals",startTimestamp:this._measurements["mark.fid"].value});"fcp"in this._measurements||delete this._measurements.cls;t.setMeasurements(this._measurements);tagMetricInfo(t,this._lcpEntry,this._clsEntry);t.setTag("sentry_reportAllChanges",this._reportAllChanges)}}};MetricsInstrumentation.prototype._trackNavigator=function(t){var e=G.navigator;if(e){var n=e.connection;if(n){n.effectiveType&&t.setTag("effectiveConnectionType",n.effectiveType);n.type&&t.setTag("connectionType",n.type);isMeasurementValue(n.rtt)&&(this._measurements["connection.rtt"]={value:n.rtt});isMeasurementValue(n.downlink)&&(this._measurements["connection.downlink"]={value:n.downlink})}isMeasurementValue(e.deviceMemory)&&t.setTag("deviceMemory",String(e.deviceMemory));isMeasurementValue(e.hardwareConcurrency)&&t.setTag("hardwareConcurrency",String(e.hardwareConcurrency))}};MetricsInstrumentation.prototype._trackCLS=function(){var t=this;getCLS((function(e){var n=e.entries.pop();if(n){E&&u.log("[Measurements] Adding CLS");t._measurements.cls={value:e.value};t._clsEntry=n}}))};MetricsInstrumentation.prototype._trackLCP=function(){var t=this;getLCP((function(e){var n=e.entries.pop();if(n){var a=msToSec(b);var r=msToSec(n.startTime);E&&u.log("[Measurements] Adding LCP");t._measurements.lcp={value:e.value};t._measurements["mark.lcp"]={value:a+r};t._lcpEntry=n}}),this._reportAllChanges)};MetricsInstrumentation.prototype._trackFID=function(){var t=this;getFID((function(e){var n=e.entries.pop();if(n){var a=msToSec(b);var r=msToSec(n.startTime);E&&u.log("[Measurements] Adding FID");t._measurements.fid={value:e.value};t._measurements["mark.fid"]={value:a+r}}}))};return MetricsInstrumentation}();function addNavigationSpans(t,e,n){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach((function(a){addPerformanceNavigationTiming(t,e,a,n)}));addPerformanceNavigationTiming(t,e,"secureConnection",n,"TLS/SSL","connectEnd");addPerformanceNavigationTiming(t,e,"fetch",n,"cache","domainLookupStart");addPerformanceNavigationTiming(t,e,"domainLookup",n,"DNS");addRequest(t,e,n)}function addMeasureSpans(t,e,n,a,r){var i=r+n;var s=i+a;_startChild(t,{description:e.name,endTimestamp:s,op:e.entryType,startTimestamp:i});return i}function addResourceSpans(t,e,n,a,r,i){if("xmlhttprequest"!==e.initiatorType&&"fetch"!==e.initiatorType){var s={};"transferSize"in e&&(s["Transfer Size"]=e.transferSize);"encodedBodySize"in e&&(s["Encoded Body Size"]=e.encodedBodySize);"decodedBodySize"in e&&(s["Decoded Body Size"]=e.decodedBodySize);var o=i+a;var c=o+r;_startChild(t,{description:n,endTimestamp:c,op:e.initiatorType?"resource."+e.initiatorType:"resource",startTimestamp:o,data:s})}}function addPerformanceNavigationTiming(t,e,n,a,r,i){var s=i?e[i]:e[n+"End"];var o=e[n+"Start"];o&&s&&_startChild(t,{op:"browser",description:null!==r&&void 0!==r?r:n,startTimestamp:a+msToSec(o),endTimestamp:a+msToSec(s)})}function addRequest(t,e,n){_startChild(t,{op:"browser",description:"request",startTimestamp:n+msToSec(e.requestStart),endTimestamp:n+msToSec(e.responseEnd)});_startChild(t,{op:"browser",description:"response",startTimestamp:n+msToSec(e.responseStart),endTimestamp:n+msToSec(e.responseEnd)})}function _startChild(e,n){var a=n.startTimestamp,r=i(n,["startTimestamp"]);a&&e.startTimestamp>a&&(e.startTimestamp=a);return e.startChild(t({startTimestamp:a},r))}function isMeasurementValue(t){return"number"===typeof t&&isFinite(t)}function tagMetricInfo(t,e,n){if(e){E&&u.log("[Measurements] Adding LCP Data");e.element&&t.setTag("lcp.element",I(e.element));e.id&&t.setTag("lcp.id",e.id);e.url&&t.setTag("lcp.url",e.url.trim().slice(0,200));t.setTag("lcp.size",e.size)}if(n&&n.sources){E&&u.log("[Measurements] Adding CLS Data");n.sources.forEach((function(e,n){return t.setTag("cls.source."+(n+1),I(e.node))}))}}var J=["localhost",/^\//];var V={traceFetch:true,traceXHR:true,tracingOrigins:J};function instrumentOutgoingRequests(e){var n=t(t({},V),e),a=n.traceFetch,r=n.traceXHR,i=n.tracingOrigins,s=n.shouldCreateSpanForRequest;var o={};var defaultShouldCreateSpan=function(t){if(o[t])return o[t];var e=i;o[t]=e.some((function(e){return x(t,e)}))&&!x(t,"sentry_key");return o[t]};var c=defaultShouldCreateSpan;"function"===typeof s&&(c=function(t){return defaultShouldCreateSpan(t)&&s(t)});var u={};a&&d("fetch",(function(t){fetchCallback(t,c,u)}));r&&d("xhr",(function(t){xhrCallback(t,c,u)}))}function fetchCallback(e,n,r){if(hasTracingEnabled()&&e.fetchData&&n(e.fetchData.url))if(e.endTimestamp){var i=e.fetchData.__span;if(!i)return;var s=r[i];if(s){e.response?s.setHttpStatus(e.response.status):e.error&&s.setStatus("internal_error");s.finish();delete r[i]}}else{var o=getActiveTransaction();if(o){s=o.startChild({data:t(t({},e.fetchData),{type:"fetch"}),description:e.fetchData.method+" "+e.fetchData.url,op:"http.client"});e.fetchData.__span=s.spanId;r[s.spanId]=s;var c=e.args[0]=e.args[0];var d=e.args[1]=e.args[1]||{};var u=d.headers;f(c,Request)&&(u=c.headers);u?"function"===typeof u.append?u.append("sentry-trace",s.toTraceparent()):u=Array.isArray(u)?a(u,[["sentry-trace",s.toTraceparent()]]):t(t({},u),{"sentry-trace":s.toTraceparent()}):u={"sentry-trace":s.toTraceparent()};d.headers=u}}}function xhrCallback(e,n,a){if(!(!hasTracingEnabled()||e.xhr&&e.xhr.__sentry_own_request__)&&e.xhr&&e.xhr.__sentry_xhr__&&n(e.xhr.__sentry_xhr__.url)){var r=e.xhr.__sentry_xhr__;if(e.endTimestamp){var i=e.xhr.__sentry_xhr_span_id__;if(!i)return;var s=a[i];if(s){s.setHttpStatus(r.status_code);s.finish();delete a[i]}}else{var o=getActiveTransaction();if(o){s=o.startChild({data:t(t({},r.data),{type:"xhr",method:r.method,url:r.url}),description:r.method+" "+r.url,op:"http.client"});e.xhr.__sentry_xhr_span_id__=s.spanId;a[e.xhr.__sentry_xhr_span_id__]=s;if(e.xhr.setRequestHeader)try{e.xhr.setRequestHeader("sentry-trace",s.toTraceparent())}catch(t){}}}}}var X=S();function instrumentRoutingWithDefaults(t,e,n){void 0===e&&(e=true);void 0===n&&(n=true);if(X&&X.location){var a=X.location.href;var r;e&&(r=t({name:X.location.pathname,op:"pageload"}));n&&d("history",(function(e){var n=e.to,i=e.from;if(void 0===i&&a&&-1!==a.indexOf(n))a=void 0;else if(i!==n){a=void 0;if(r){E&&u.log("[Tracing] Finishing current transaction with op: "+r.op);r.finish()}r=t({name:X.location.pathname,op:"navigation"})}}))}else E&&u.warn("Could not initialize routing instrumentation due to invalid location")}var Q=600;var K=t({idleTimeout:A,markBackgroundTransactions:true,maxTransactionDuration:Q,routingInstrumentation:instrumentRoutingWithDefaults,startTransactionOnLocationChange:true,startTransactionOnPageLoad:true},V);var Z=function(){function BrowserTracing(e){this.name=BrowserTracing.id;this._configuredIdleTimeout=void 0;var n=V.tracingOrigins;if(e){this._configuredIdleTimeout=e.idleTimeout;e.tracingOrigins&&Array.isArray(e.tracingOrigins)&&0!==e.tracingOrigins.length?n=e.tracingOrigins:E&&(this._emitOptionsWarning=true)}this.options=t(t(t({},K),e),{tracingOrigins:n});var a=this.options._metricOptions;this._metrics=new U(a&&a._reportAllChanges)}BrowserTracing.prototype.setupOnce=function(t,e){var n=this;this._getCurrentHub=e;if(this._emitOptionsWarning){E&&u.warn("[Tracing] You need to define `tracingOrigins` in the options. Set an array of urls or patterns to trace.");E&&u.warn("[Tracing] We added a reasonable default for you: "+V.tracingOrigins)}var a=this.options,r=a.routingInstrumentation,i=a.startTransactionOnLocationChange,s=a.startTransactionOnPageLoad,o=a.markBackgroundTransactions,c=a.traceFetch,d=a.traceXHR,p=a.tracingOrigins,l=a.shouldCreateSpanForRequest;r((function(t){return n._createRouteTransaction(t)}),s,i);o&&registerBackgroundTabDetection();instrumentOutgoingRequests({traceFetch:c,traceXHR:d,tracingOrigins:p,shouldCreateSpanForRequest:l})};BrowserTracing.prototype._createRouteTransaction=function(e){var n=this;if(this._getCurrentHub){var a=this.options,r=a.beforeNavigate,i=a.idleTimeout,s=a.maxTransactionDuration;var o="pageload"===e.op?getHeaderContext():void 0;var c=t(t(t({},e),o),{trimEnd:true});var d="function"===typeof r?r(c):c;var p=void 0===d?t(t({},c),{sampled:false}):d;false===p.sampled&&E&&u.log("[Tracing] Will not send "+p.op+" transaction because of beforeNavigate.");E&&u.log("[Tracing] Starting "+p.op+" transaction on scope");var l=this._getCurrentHub();var m=S().location;var f=startIdleTransaction(l,p,i,true,{location:m});f.registerBeforeFinishCallback((function(t,e){n._metrics.addPerformanceEntries(t);adjustTransactionDuration(secToMs(s),t,e)}));f.setTag("idleTimeout",this._configuredIdleTimeout);return f}E&&u.warn("[Tracing] Did not create "+e.op+" transaction because _getCurrentHub is invalid.")};BrowserTracing.id="BrowserTracing";return BrowserTracing}();
/**
 * Gets transaction context from a sentry-trace meta.
 *
 * @returns Transaction context data from the header or undefined if there's no header or the header is malformed
 */function getHeaderContext(){var t=getMetaContent("sentry-trace");if(t)return C(t)}function getMetaContent(t){var e=S().document.querySelector("meta[name="+t+"]");return e?e.getAttribute("content"):null}function adjustTransactionDuration(t,e,n){var a=n-e.startTimestamp;var r=n&&(a>t||a<0);if(r){e.setStatus("deadline_exceeded");e.setTag("maxTransactionDurationExceeded","true")}}var $=Object.freeze(Object.defineProperty({__proto__:null,Express:P,Postgres:H,Mysql:F,Mongo:j,BrowserTracing:Z},Symbol.toStringTag,{value:"Module"}));
/** The status of an Span.
 *
 * @deprecated Use string literals - if you require type casting, cast to SpanStatusType type
 */var tt;(function(t){t.Ok="ok";t.DeadlineExceeded="deadline_exceeded";t.Unauthenticated="unauthenticated";t.PermissionDenied="permission_denied";t.NotFound="not_found";t.ResourceExhausted="resource_exhausted";t.InvalidArgument="invalid_argument";t.Unimplemented="unimplemented";t.Unavailable="unavailable";t.InternalError="internal_error";t.UnknownError="unknown_error";t.Cancelled="cancelled";t.AlreadyExists="already_exists";t.FailedPrecondition="failed_precondition";t.Aborted="aborted";t.OutOfRange="out_of_range";t.DataLoss="data_loss"})(tt||(tt={}));addExtensionMethods();export{Z as BrowserTracing,q as IdleTransaction,$ as Integrations,k as Span,tt as SpanStatus,w as Transaction,addExtensionMethods,V as defaultRequestInstrumentationOptions,getActiveTransaction,hasTracingEnabled,instrumentOutgoingRequests as registerRequestInstrumentation,spanStatusfromHttpCode,startIdleTransaction};

