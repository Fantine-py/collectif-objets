import{__spread as t,__assign as e}from"tslib";import{isPlainObject as s,dateTimestampInSeconds as i,getGlobalSingleton as n,SyncPromise as r,isThenable as o,uuid4 as a,timestampInSeconds as u,dropUndefinedKeys as p,consoleSandbox as c,logger as h,getGlobalObject as _,isNodeEnv as g}from"@sentry/utils";var d=100;var f=function(){function Scope(){this._notifyingListeners=false;this._scopeListeners=[];this._eventProcessors=[];this._breadcrumbs=[];this._user={};this._tags={};this._extra={};this._contexts={};this._sdkProcessingMetadata={}}
/**
     * Inherit values from the parent scope.
     * @param scope to clone.
     */Scope.clone=function(s){var i=new Scope;if(s){i._breadcrumbs=t(s._breadcrumbs);i._tags=e({},s._tags);i._extra=e({},s._extra);i._contexts=e({},s._contexts);i._user=s._user;i._level=s._level;i._span=s._span;i._session=s._session;i._transactionName=s._transactionName;i._fingerprint=s._fingerprint;i._eventProcessors=t(s._eventProcessors);i._requestSession=s._requestSession}return i};Scope.prototype.addScopeListener=function(t){this._scopeListeners.push(t)};Scope.prototype.addEventProcessor=function(t){this._eventProcessors.push(t);return this};Scope.prototype.setUser=function(t){this._user=t||{};this._session&&this._session.update({user:t});this._notifyScopeListeners();return this};Scope.prototype.getUser=function(){return this._user};Scope.prototype.getRequestSession=function(){return this._requestSession};Scope.prototype.setRequestSession=function(t){this._requestSession=t;return this};Scope.prototype.setTags=function(t){this._tags=e(e({},this._tags),t);this._notifyScopeListeners();return this};Scope.prototype.setTag=function(t,s){var i;this._tags=e(e({},this._tags),(i={},i[t]=s,i));this._notifyScopeListeners();return this};Scope.prototype.setExtras=function(t){this._extra=e(e({},this._extra),t);this._notifyScopeListeners();return this};Scope.prototype.setExtra=function(t,s){var i;this._extra=e(e({},this._extra),(i={},i[t]=s,i));this._notifyScopeListeners();return this};Scope.prototype.setFingerprint=function(t){this._fingerprint=t;this._notifyScopeListeners();return this};Scope.prototype.setLevel=function(t){this._level=t;this._notifyScopeListeners();return this};Scope.prototype.setTransactionName=function(t){this._transactionName=t;this._notifyScopeListeners();return this};
/**
     * Can be removed in major version.
     * @deprecated in favor of {@link this.setTransactionName}
     */Scope.prototype.setTransaction=function(t){return this.setTransactionName(t)};Scope.prototype.setContext=function(t,s){var i;null===s?delete this._contexts[t]:this._contexts=e(e({},this._contexts),(i={},i[t]=s,i));this._notifyScopeListeners();return this};Scope.prototype.setSpan=function(t){this._span=t;this._notifyScopeListeners();return this};Scope.prototype.getSpan=function(){return this._span};Scope.prototype.getTransaction=function(){var t=this.getSpan();return t&&t.transaction};Scope.prototype.setSession=function(t){t?this._session=t:delete this._session;this._notifyScopeListeners();return this};Scope.prototype.getSession=function(){return this._session};Scope.prototype.update=function(t){if(!t)return this;if("function"===typeof t){var i=t(this);return i instanceof Scope?i:this}if(t instanceof Scope){this._tags=e(e({},this._tags),t._tags);this._extra=e(e({},this._extra),t._extra);this._contexts=e(e({},this._contexts),t._contexts);t._user&&Object.keys(t._user).length&&(this._user=t._user);t._level&&(this._level=t._level);t._fingerprint&&(this._fingerprint=t._fingerprint);t._requestSession&&(this._requestSession=t._requestSession)}else if(s(t)){t=t;this._tags=e(e({},this._tags),t.tags);this._extra=e(e({},this._extra),t.extra);this._contexts=e(e({},this._contexts),t.contexts);t.user&&(this._user=t.user);t.level&&(this._level=t.level);t.fingerprint&&(this._fingerprint=t.fingerprint);t.requestSession&&(this._requestSession=t.requestSession)}return this};Scope.prototype.clear=function(){this._breadcrumbs=[];this._tags={};this._extra={};this._user={};this._contexts={};this._level=void 0;this._transactionName=void 0;this._fingerprint=void 0;this._requestSession=void 0;this._span=void 0;this._session=void 0;this._notifyScopeListeners();return this};Scope.prototype.addBreadcrumb=function(s,n){var r="number"===typeof n?Math.min(n,d):d;if(r<=0)return this;var o=e({timestamp:i()},s);this._breadcrumbs=t(this._breadcrumbs,[o]).slice(-r);this._notifyScopeListeners();return this};Scope.prototype.clearBreadcrumbs=function(){this._breadcrumbs=[];this._notifyScopeListeners();return this};
/**
     * Applies the current context and fingerprint to the event.
     * Note that breadcrumbs will be added by the client.
     * Also if the event has already breadcrumbs on it, we do not merge them.
     * @param event Event
     * @param hint May contain additional information about the original exception.
     * @hidden
     */Scope.prototype.applyToEvent=function(s,i){this._extra&&Object.keys(this._extra).length&&(s.extra=e(e({},this._extra),s.extra));this._tags&&Object.keys(this._tags).length&&(s.tags=e(e({},this._tags),s.tags));this._user&&Object.keys(this._user).length&&(s.user=e(e({},this._user),s.user));this._contexts&&Object.keys(this._contexts).length&&(s.contexts=e(e({},this._contexts),s.contexts));this._level&&(s.level=this._level);this._transactionName&&(s.transaction=this._transactionName);if(this._span){s.contexts=e({trace:this._span.getTraceContext()},s.contexts);var n=this._span.transaction&&this._span.transaction.name;n&&(s.tags=e({transaction:n},s.tags))}this._applyFingerprint(s);s.breadcrumbs=t(s.breadcrumbs||[],this._breadcrumbs);s.breadcrumbs=s.breadcrumbs.length>0?s.breadcrumbs:void 0;s.sdkProcessingMetadata=this._sdkProcessingMetadata;return this._notifyEventProcessors(t(getGlobalEventProcessors(),this._eventProcessors),s,i)};Scope.prototype.setSDKProcessingMetadata=function(t){this._sdkProcessingMetadata=e(e({},this._sdkProcessingMetadata),t);return this};Scope.prototype._notifyEventProcessors=function(t,s,i,n){var a=this;void 0===n&&(n=0);return new r((function(r,u){var p=t[n];if(null===s||"function"!==typeof p)r(s);else{var c=p(e({},s),i);o(c)?void c.then((function(e){return a._notifyEventProcessors(t,e,i,n+1).then(r)})).then(null,u):void a._notifyEventProcessors(t,c,i,n+1).then(r).then(null,u)}}))};Scope.prototype._notifyScopeListeners=function(){var t=this;if(!this._notifyingListeners){this._notifyingListeners=true;this._scopeListeners.forEach((function(e){e(t)}));this._notifyingListeners=false}};Scope.prototype._applyFingerprint=function(t){t.fingerprint=t.fingerprint?Array.isArray(t.fingerprint)?t.fingerprint:[t.fingerprint]:[];this._fingerprint&&(t.fingerprint=t.fingerprint.concat(this._fingerprint));t.fingerprint&&!t.fingerprint.length&&delete t.fingerprint};return Scope}();function getGlobalEventProcessors(){return n("globalEventProcessors",(function(){return[]}))}
/**
 * Add a EventProcessor to be kept globally.
 * @param callback EventProcessor to add
 */function addGlobalEventProcessor(t){getGlobalEventProcessors().push(t)}var v=function(){function Session(t){this.errors=0;this.sid=a();this.duration=0;this.status="ok";this.init=true;this.ignoreDuration=false;var e=u();this.timestamp=e;this.started=e;t&&this.update(t)}Session.prototype.update=function(t){void 0===t&&(t={});if(t.user){!this.ipAddress&&t.user.ip_address&&(this.ipAddress=t.user.ip_address);this.did||t.did||(this.did=t.user.id||t.user.email||t.user.username)}this.timestamp=t.timestamp||u();t.ignoreDuration&&(this.ignoreDuration=t.ignoreDuration);t.sid&&(this.sid=32===t.sid.length?t.sid:a());void 0!==t.init&&(this.init=t.init);!this.did&&t.did&&(this.did=""+t.did);"number"===typeof t.started&&(this.started=t.started);if(this.ignoreDuration)this.duration=void 0;else if("number"===typeof t.duration)this.duration=t.duration;else{var e=this.timestamp-this.started;this.duration=e>=0?e:0}t.release&&(this.release=t.release);t.environment&&(this.environment=t.environment);!this.ipAddress&&t.ipAddress&&(this.ipAddress=t.ipAddress);!this.userAgent&&t.userAgent&&(this.userAgent=t.userAgent);"number"===typeof t.errors&&(this.errors=t.errors);t.status&&(this.status=t.status)};Session.prototype.close=function(t){t?this.update({status:t}):"ok"===this.status?this.update({status:"exited"}):this.update()};Session.prototype.toJSON=function(){return p({sid:""+this.sid,init:this.init,started:new Date(1e3*this.started).toISOString(),timestamp:new Date(1e3*this.timestamp).toISOString(),status:this.status,errors:this.errors,did:"number"===typeof this.did||"string"===typeof this.did?""+this.did:void 0,duration:this.duration,attrs:{release:this.release,environment:this.environment,ip_address:this.ipAddress,user_agent:this.userAgent}})};return Session}();var l="undefined"===typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__;var S=4;var y=100;var b=function(){
/**
     * Creates a new instance of the hub, will push one {@link Layer} into the
     * internal stack on creation.
     *
     * @param client bound to the hub.
     * @param scope bound to the hub.
     * @param version number, higher number means higher priority.
     */
function Hub(t,e,s){void 0===e&&(e=new f);void 0===s&&(s=S);this._version=s;this._stack=[{}];this.getStackTop().scope=e;t&&this.bindClient(t)}Hub.prototype.isOlderThan=function(t){return this._version<t};Hub.prototype.bindClient=function(t){var e=this.getStackTop();e.client=t;t&&t.setupIntegrations&&t.setupIntegrations()};Hub.prototype.pushScope=function(){var t=f.clone(this.getScope());this.getStack().push({client:this.getClient(),scope:t});return t};Hub.prototype.popScope=function(){return!(this.getStack().length<=1)&&!!this.getStack().pop()};Hub.prototype.withScope=function(t){var e=this.pushScope();try{t(e)}finally{this.popScope()}};Hub.prototype.getClient=function(){return this.getStackTop().client};Hub.prototype.getScope=function(){return this.getStackTop().scope};Hub.prototype.getStack=function(){return this._stack};Hub.prototype.getStackTop=function(){return this._stack[this._stack.length-1]};Hub.prototype.captureException=function(t,s){var i=this._lastEventId=s&&s.event_id?s.event_id:a();var n=s;if(!s){var r=void 0;try{throw new Error("Sentry syntheticException")}catch(t){r=t}n={originalException:t,syntheticException:r}}this._invokeClient("captureException",t,e(e({},n),{event_id:i}));return i};Hub.prototype.captureMessage=function(t,s,i){var n=this._lastEventId=i&&i.event_id?i.event_id:a();var r=i;if(!i){var o=void 0;try{throw new Error(t)}catch(t){o=t}r={originalException:t,syntheticException:o}}this._invokeClient("captureMessage",t,s,e(e({},r),{event_id:n}));return n};Hub.prototype.captureEvent=function(t,s){var i=s&&s.event_id?s.event_id:a();"transaction"!==t.type&&(this._lastEventId=i);this._invokeClient("captureEvent",t,e(e({},s),{event_id:i}));return i};Hub.prototype.lastEventId=function(){return this._lastEventId};Hub.prototype.addBreadcrumb=function(t,s){var n=this.getStackTop(),r=n.scope,o=n.client;if(r&&o){var a=o.getOptions&&o.getOptions()||{},u=a.beforeBreadcrumb,p=void 0===u?null:u,h=a.maxBreadcrumbs,_=void 0===h?y:h;if(!(_<=0)){var g=i();var d=e({timestamp:g},t);var f=p?c((function(){return p(d,s)})):d;null!==f&&r.addBreadcrumb(f,_)}}};Hub.prototype.setUser=function(t){var e=this.getScope();e&&e.setUser(t)};Hub.prototype.setTags=function(t){var e=this.getScope();e&&e.setTags(t)};Hub.prototype.setExtras=function(t){var e=this.getScope();e&&e.setExtras(t)};Hub.prototype.setTag=function(t,e){var s=this.getScope();s&&s.setTag(t,e)};Hub.prototype.setExtra=function(t,e){var s=this.getScope();s&&s.setExtra(t,e)};Hub.prototype.setContext=function(t,e){var s=this.getScope();s&&s.setContext(t,e)};Hub.prototype.configureScope=function(t){var e=this.getStackTop(),s=e.scope,i=e.client;s&&i&&t(s)};Hub.prototype.run=function(t){var e=makeMain(this);try{t(this)}finally{makeMain(e)}};Hub.prototype.getIntegration=function(t){var e=this.getClient();if(!e)return null;try{return e.getIntegration(t)}catch(e){l&&h.warn("Cannot retrieve integration "+t.id+" from the current Hub");return null}};Hub.prototype.startSpan=function(t){return this._callExtensionMethod("startSpan",t)};Hub.prototype.startTransaction=function(t,e){return this._callExtensionMethod("startTransaction",t,e)};Hub.prototype.traceHeaders=function(){return this._callExtensionMethod("traceHeaders")};Hub.prototype.captureSession=function(t){void 0===t&&(t=false);if(t)return this.endSession();this._sendSessionUpdate()};Hub.prototype.endSession=function(){var t=this.getStackTop();var e=t&&t.scope;var s=e&&e.getSession();s&&s.close();this._sendSessionUpdate();e&&e.setSession()};Hub.prototype.startSession=function(t){var s=this.getStackTop(),i=s.scope,n=s.client;var r=n&&n.getOptions()||{},o=r.release,a=r.environment;var u=_();var p=(u.navigator||{}).userAgent;var c=new v(e(e(e({release:o,environment:a},i&&{user:i.getUser()}),p&&{userAgent:p}),t));if(i){var h=i.getSession&&i.getSession();h&&"ok"===h.status&&h.update({status:"exited"});this.endSession();i.setSession(c)}return c};Hub.prototype._sendSessionUpdate=function(){var t=this.getStackTop(),e=t.scope,s=t.client;if(e){var i=e.getSession&&e.getSession();i&&s&&s.captureSession&&s.captureSession(i)}};
/**
     * Internal helper function to call a method on the top client if it exists.
     *
     * @param method The method to call on the client.
     * @param args Arguments to pass to the client function.
     */Hub.prototype._invokeClient=function(e){var s;var i=[];for(var n=1;n<arguments.length;n++)i[n-1]=arguments[n];var r=this.getStackTop(),o=r.scope,a=r.client;a&&a[e]&&(s=a)[e].apply(s,t(i,[o]))};Hub.prototype._callExtensionMethod=function(t){var e=[];for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];var i=getMainCarrier();var n=i.__SENTRY__;if(n&&n.extensions&&"function"===typeof n.extensions[t])return n.extensions[t].apply(this,e);l&&h.warn("Extension method "+t+" couldn't be found, doing nothing.")};return Hub}();function getMainCarrier(){var t=_();t.__SENTRY__=t.__SENTRY__||{extensions:{},hub:void 0};return t}
/**
 * Replaces the current main hub with the passed one on the global object
 *
 * @returns The old replaced hub
 */function makeMain(t){var e=getMainCarrier();var s=getHubFromCarrier(e);setHubOnCarrier(e,t);return s}function getCurrentHub(){var t=getMainCarrier();hasHubOnCarrier(t)&&!getHubFromCarrier(t).isOlderThan(S)||setHubOnCarrier(t,new b);return g()?getHubFromActiveDomain(t):getHubFromCarrier(t)}
/**
 * Returns the active domain, if one exists
 * @deprecated No longer used; remove in v7
 * @returns The domain, or undefined if there is no active domain
 */function getActiveDomain(){l&&h.warn("Function `getActiveDomain` is deprecated and will be removed in a future version.");var t=getMainCarrier().__SENTRY__;return t&&t.extensions&&t.extensions.domain&&t.extensions.domain.active}
/**
 * Try to read the hub from an active domain, and fallback to the registry if one doesn't exist
 * @returns discovered hub
 */function getHubFromActiveDomain(t){try{var e=getMainCarrier().__SENTRY__;var s=e&&e.extensions&&e.extensions.domain&&e.extensions.domain.active;if(!s)return getHubFromCarrier(t);if(!hasHubOnCarrier(s)||getHubFromCarrier(s).isOlderThan(S)){var i=getHubFromCarrier(t).getStackTop();setHubOnCarrier(s,new b(i.client,f.clone(i.scope)))}return getHubFromCarrier(s)}catch(e){return getHubFromCarrier(t)}}
/**
 * This will tell whether a carrier has a hub on it or not
 * @param carrier object
 */function hasHubOnCarrier(t){return!!(t&&t.__SENTRY__&&t.__SENTRY__.hub)}
/**
 * This will create a new {@link Hub} and add to the passed object on
 * __SENTRY__.hub.
 * @param carrier object
 * @hidden
 */function getHubFromCarrier(t){return n("hub",(function(){return new b}),t)}
/**
 * This will set passed {@link Hub} on the passed object's __SENTRY__.hub attribute
 * @param carrier object
 * @param hub Hub
 * @returns A boolean indicating success or failure
 */function setHubOnCarrier(t,e){if(!t)return false;var s=t.__SENTRY__=t.__SENTRY__||{};s.hub=e;return true}var m=function(){function SessionFlusher(t,e){var s=this;this.flushTimeout=60;this._pendingAggregates={};this._isEnabled=true;this._transport=t;this._intervalId=setInterval((function(){return s.flush()}),1e3*this.flushTimeout);this._sessionAttrs=e}SessionFlusher.prototype.sendSessionAggregates=function(t){this._transport.sendSession?void this._transport.sendSession(t).then(null,(function(t){l&&h.error("Error while sending session:",t)})):l&&h.warn("Dropping session because custom transport doesn't implement sendSession")};SessionFlusher.prototype.flush=function(){var t=this.getSessionAggregates();if(0!==t.aggregates.length){this._pendingAggregates={};this.sendSessionAggregates(t)}};SessionFlusher.prototype.getSessionAggregates=function(){var t=this;var e=Object.keys(this._pendingAggregates).map((function(e){return t._pendingAggregates[parseInt(e)]}));var s={attrs:this._sessionAttrs,aggregates:e};return p(s)};SessionFlusher.prototype.close=function(){clearInterval(this._intervalId);this._isEnabled=false;this.flush()};SessionFlusher.prototype.incrementSessionStatusCount=function(){if(this._isEnabled){var t=getCurrentHub().getScope();var e=t&&t.getRequestSession();if(e&&e.status){this._incrementSessionStatusCount(e.status,new Date);t&&t.setRequestSession(void 0)
/* eslint-enable @typescript-eslint/no-unsafe-member-access */}}};SessionFlusher.prototype._incrementSessionStatusCount=function(t,e){var s=new Date(e).setSeconds(0,0);this._pendingAggregates[s]=this._pendingAggregates[s]||{};var i=this._pendingAggregates[s];i.started||(i.started=new Date(s).toISOString());switch(t){case"errored":i.errored=(i.errored||0)+1;return i.errored;case"ok":i.exited=(i.exited||0)+1;return i.exited;default:i.crashed=(i.crashed||0)+1;return i.crashed}};return SessionFlusher}();export{b as Hub,f as Scope,v as Session,m as SessionFlusher,addGlobalEventProcessor,getActiveDomain,getCurrentHub,getHubFromCarrier,getMainCarrier,makeMain,setHubOnCarrier};

